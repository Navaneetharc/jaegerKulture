<%- include('../partials/adminL/header.ejs') %>

<div class="wrapper">
    <!-- Sidebar -->
    <aside class="navbar-aside" id="offcanvas_aside">
        <div class="aside-top">
            <a href="/admin" class="brand-wrap">
                <img src="/assets/imgs/theme/jaeger.png" class="logo" alt="Jaeger Dashboard">
            </a>
            <div>
                <button class="btn btn-icon btn-aside-minimize"> <i class="text-muted material-icons md-menu_open"></i> </button>
            </div>
        </div>
        <nav>
            <ul class="menu-aside">
                <li class="menu-item active">
                    <a class="menu-link" href="/admin"> <i class="icon material-icons md-home"></i>
                        <span class="text">Dashboard</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/users"> <i class="icon material-icons md-person"></i>
                        <span class="text">Customers</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/products"> <i class="icon material-icons md-shopping_bag"></i>
                        <span class="text">Products</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/orders"> <i class="icon material-icons md-shopping_cart"></i>
                        <span class="text">Orders</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/category"> <i class="icon material-icons md-store"></i>
                        <span class="text">Category</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a class="menu-link" href="/admin/coupons"> <i class="icon material-icons md-local_offer"></i>
                        <span class="text">Coupons</span>
                    </a>
                </li>
               
                <li class="menu-item">
                    <a class="menu-link" href="/admin/sales"> <i class="icon material-icons md-assessment"></i>
                        <span class="text">Sales Report</span>
                    </a>
                </li>
              
            </ul>
            <hr>
           
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-wrap">
        <header class="main-header navbar">
            <div class="col-search">
                <form class="searchform">
                    <div class="input-group">
                        <input list="search_terms" type="text" class="form-control" placeholder="Search term">
                        <button class="btn btn-light" type="button"> <i class="material-icons md-search"></i></button>
                    </div>
                    <datalist id="search_terms">
                        <option value="Products">
                        <option value="New orders">
                        <option value="Apple iphone">
                        <option value="Customer name">
                    </datalist>
                </form>
            </div>
            <div class="col-nav">
                <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"> <i class="material-icons md-apps"></i> </button>
                <ul class="nav">
                    
                    
                    <li class="nav-item">
                        <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
                    </li>
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownLanguage" aria-expanded="false"><i class="material-icons md-public"></i></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
                            <a class="dropdown-item text-brand" href="#"><img src="/assets/imgs/theme/flag-us.png" alt="English">English</a>
                            <a class="dropdown-item" href="#"><img src="/assets/imgs/theme/flag-fr.png" alt="Français">Français</a>
                            <a class="dropdown-item" href="#"><img src="/assets/imgs/theme/flag-jp.png" alt="日本語">日本語</a>
                            <a class="dropdown-item" href="#"><img src="/assets/imgs/theme/flag-cn.png" alt="中国人">中国人</a>
                        </div>
                    </li>
                    <li class="dropdown nav-item">
                        <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false"> <img class="img-xs rounded-circle" src="/assets/imgs/people/avatar2.jpg" alt="User"></a>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                            
                            <a class="dropdown-item text-danger" href="/admin/logout"><i class="material-icons md-exit_to_app"></i>Logout</a>
                        </div>
                    </li>
                </ul>
            </div>
        </header>

        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Dashboard</h2>
                    <p>Whole data about your business here</p>
                </div>
            </div>
            
            <!-- Global Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Time Filter</h5>
                        <div class="btn-group" role="group" aria-label="Time Filter">
                            <button type="button" class="btn btn-sm btn-outline-secondary active global-filter-btn" data-filter="weekly">Weekly</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary global-filter-btn" data-filter="monthly">Monthly</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary global-filter-btn" data-filter="yearly">Yearly</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats Cards Row -->
            <div class="row">
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-primary-light"><i class="text-primary material-icons md-monetization_on"></i></span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Revenue</h6>
                                <span class="revenue-value">₹<%= totalRevenue.toFixed(2) %></span>
                                <span class="text-sm">
                                    Shipping fees are not included
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-success-light"><i class="text-success material-icons md-local_shipping"></i></span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Orders</h6> 
                                <span class="orders-value"><%= totalOrders %></span>
                                <span class="text-sm">
                                    Excluding orders in transit
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-warning-light"><i class="text-warning material-icons md-qr_code"></i></span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Products</h6> 
                                <span class="products-value"><%= totalProducts %></span>
                                <span class="text-sm">
                                    In <%= totalCategories %> Categories
                                </span>
                            </div>
                        </article>
                    </div>
                </div>
                <!-- <div class="col-lg-3">
                    <div class="card card-body mb-4">
                        <article class="icontext">
                            <span class="icon icon-sm rounded-circle bg-info-light"><i class="text-info material-icons md-shopping_basket"></i></span>
                            <div class="text">
                                <h6 class="mb-1 card-title">Monthly Earning</h6> 
                                <span class="monthly-earning-value">₹<%= monthlyEarning.toFixed(2) %></span>
                                <span class="text-sm">
                                    Based on your local time
                                </span>
                            </div>
                        </article>
                    </div>
                </div> -->
            </div>
                            
            <!-- Charts Row -->
            <div class="row">
                <div class="col-xl-8 col-lg-12">
                    <div class="card mb-4">
                        <article class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Sale Statistics</h5>
                            </div>
                            <div class="chart-container" style="position: relative; height:300px; width:100%; min-height:300px;">
                                <canvas id="myChart"></canvas>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="col-xl-4 col-lg-12">
                    <div class="card mb-4">
                        <article class="card-body">
                            <h5 class="card-title">Best Selling Categories</h5>
                            <div class="chart-container" style="position: relative; height:217px; width:100%; min-height:217px;">
                                <canvas id="myChart2"></canvas>
                            </div>
                        </article>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <article class="card-body">
                            <h5 class="card-title">Top 5 Selling Products</h5>
                            <div class="top-products-container" id="topProductsContainer">
                                <% if (topProducts && topProducts.length > 0) { %>
                                    <% topProducts.forEach(product => { %>
                                        <div class="product-progress-item">
                                            <span class="text-muted font-xs"><%= product.productName %></span>
                                            <div class="progress mb-3">
                                                <div class="progress-bar" role="progressbar" style="width: '<%- product.percentage %>%"><%- product.percentage %>%</div>
                                            </div>
                                        </div>
                                    <% }); %>
                                <% } else { %>
                                    <span class="text-muted">No product data available</span>
                                <% } %>
                            </div>
                        </article>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<script src="/assets/js/vendors/jquery-3.6.0.min.js"></script>
<script src="/assets/js/vendors/bootstrap.bundle.min.js"></script>
<script src="/assets/js/vendors/select2.min.js"></script>
<script src="/assets/js/vendors/perfect-scrollbar.js"></script>
<script src="/assets/js/vendors/jquery.fullscreen.min.js"></script>
<script src="/assets/js/vendors/chart.js"></script>

<script src="/assets/js/main.js" type="text/javascript"></script>

<script>
$(document).ready(function() {
    var weeklyChartData = JSON.parse('<%- JSON.stringify(weeklyChartData) %>');
    var monthlyChartData = JSON.parse('<%- JSON.stringify(monthlyChartData) %>');
    var yearlyChartData = JSON.parse('<%- JSON.stringify(yearlyChartData) %>');
    
    var weeklyCategoryData = {
        labels: JSON.parse('<%- JSON.stringify(categoryChartData.labels) %>'),
        data: JSON.parse('<%- JSON.stringify(categoryChartData.data) %>')
    };
    
    var monthlyCategoryData = {
        labels: JSON.parse('<%- JSON.stringify(categoryChartData.labels) %>'),
        data: JSON.parse('<%- JSON.stringify(categoryChartData.data) %>')
    };
    
    var yearlyCategoryData = {
        labels: JSON.parse('<%- JSON.stringify(categoryChartData.labels) %>'),
        data: JSON.parse('<%- JSON.stringify(categoryChartData.data) %>')
    };
    
    var weeklyTopProducts = JSON.parse('<%- JSON.stringify(topProducts) %>');
    var monthlyTopProducts = JSON.parse('<%- JSON.stringify(topProducts) %>');
    var yearlyTopProducts = JSON.parse('<%- JSON.stringify(topProducts) %>');
    
    let salesChart = null;
    let categoryChart = null;
    
    const chartData = {
        weekly: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            data: weeklyChartData,
            categoryLabels: weeklyCategoryData.labels,
            categoryData: weeklyCategoryData.data,
            topProducts: weeklyTopProducts,
            revenue: '<%= totalRevenue.toFixed(2) %>',
            orders: '<%= totalOrders %>',
            products: '<%= totalProducts %>',
            monthlyEarning: '<%= monthlyEarning.toFixed(2) %>'
        },
        monthly: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            data: monthlyChartData,
            categoryLabels: monthlyCategoryData.labels,
            categoryData: monthlyCategoryData.data,
            topProducts: monthlyTopProducts,
            revenue: '<%= totalRevenue.toFixed(2) %>',
            orders: '<%= totalOrders %>',
            products: '<%= totalProducts %>',
            monthlyEarning: '<%= monthlyEarning.toFixed(2) %>'
        },
        yearly: {
            labels: [
                '<%= new Date().getFullYear() - 5 %>',
                '<%= new Date().getFullYear() - 4 %>',
                '<%= new Date().getFullYear() - 3 %>',
                '<%= new Date().getFullYear() - 2 %>',
                '<%= new Date().getFullYear() - 1 %>',
                '<%= new Date().getFullYear() %>'
            ],
            data: yearlyChartData,
            categoryLabels: yearlyCategoryData.labels,
            categoryData: yearlyCategoryData.data,
            topProducts: yearlyTopProducts,
            revenue: '<%= totalRevenue.toFixed(2) %>',
            orders: '<%= totalOrders %>',
            products: '<%= totalProducts %>',
            monthlyEarning: '<%= monthlyEarning.toFixed(2) %>'
        }
    };

    function updateAllCharts(filter) {
        updateSalesChart(filter);
        
        updateCategoryChart(filter);
        
        updateTopProducts(filter);
        
        updateStatsCards(filter);
    }
    
    function updateSalesChart(filter) {
        const ctx = document.getElementById('myChart').getContext('2d');
        
        if (salesChart) {
            salesChart.destroy();
        }
        
        salesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData[filter].labels,
                datasets: [{
                    label: 'Sales',
                    data: chartData[filter].data,
                    fill: true,
                    backgroundColor: 'rgba(44, 120, 220, 0.2)',
                    borderColor: 'rgba(44, 120, 220)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(44, 120, 220)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                animation: {
                    duration: 500
                },
                elements: {
                    point: {
                        radius: 3,
                        hoverRadius: 5
                    }
                }
            }
        });
    }
    
    function updateCategoryChart(filter) {
        const ctx2 = document.getElementById('myChart2').getContext('2d');
        
        if (categoryChart) {
            categoryChart.destroy();
        }
        
        if (chartData[filter].categoryLabels && chartData[filter].categoryLabels.length > 0) {
            categoryChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: chartData[filter].categoryLabels,
                    datasets: [{
                        data: chartData[filter].categoryData,
                        backgroundColor: [
                            '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff',
                            '#ff9f40', '#c9cbcf', '#66ff99', '#ff66cc', '#666699'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 500
                    },
                    cutout: '70%'
                }
            });
        } else {
            console.error('Category chart data not available for ' + filter);
        }
    }
    
    function updateTopProducts(filter) {
        const container = document.getElementById('topProductsContainer');
        const products = chartData[filter].topProducts;
        
        if (products && products.length > 0) {
            let html = '';
            products.forEach(product => {
                html += `
                <div class="product-progress-item">
                    <span class="text-muted font-xs">${product.productName}</span>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: ${product.percentage}%">${product.percentage}%</div>
                    </div>
                </div>
                `;
            });
            container.innerHTML = html;
        } else {
            container.innerHTML = '<span class="text-muted">No product data available</span>';
        }
    }
    
    function updateStatsCards(filter) {
        document.querySelector('.revenue-value').innerHTML = '₹' + chartData[filter].revenue;
        document.querySelector('.orders-value').innerHTML = chartData[filter].orders;
        document.querySelector('.products-value').innerHTML = chartData[filter].products;
        document.querySelector('.monthly-earning-value').innerHTML = '₹' + chartData[filter].monthlyEarning;
    }
    
    updateAllCharts('weekly');
    
    $('.global-filter-btn').on('click', function() {
        const filter = $(this).data('filter');
        $('.global-filter-btn').removeClass('active');
        $(this).addClass('active');
        updateAllCharts(filter);
    });
    
    $(window).on('load', function() {
        setTimeout(function() {
            if (typeof Chart !== 'undefined') {
                const salesChartCanvas = document.getElementById('myChart');
                const categoryChartCanvas = document.getElementById('myChart2');
                
                if (salesChartCanvas) {
                    salesChartCanvas.style.display = 'none';
                    salesChartCanvas.offsetHeight; // Force a reflow
                    salesChartCanvas.style.display = 'block';
                }
                
                if (categoryChartCanvas) {
                    categoryChartCanvas.style.display = 'none';
                    categoryChartCanvas.offsetHeight; 
                    categoryChartCanvas.style.display = 'block';
                }
            }
            
            $(window).off('resize.dashboard');
        }, 500);
    });
});
</script>

<style>

    .wrapper {
        display: flex;
        width: 100%;
        align-items: stretch;
        overflow-x: hidden;
    }
    
    .main-wrap {
        width: 100%;
        min-height: 100vh;
        overflow-x: hidden;
    }
    
    .chart-container {
        position: relative;
        margin: auto;
    }
    
    .top-products-container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .card {
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        margin-bottom: 1rem;
    }
    
    .card:hover {
        box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
    }
    
    .navbar-aside {
        width: 250px;
        height: 100vh;
        position: fixed;
        overflow-y: auto;
        z-index: 1030;
    }
    
    @media (max-width: 992px) {
        .navbar-aside {
            width: 100%;
            height: auto;
            position: relative;
        }
    }
    html, body {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    .progress {
        overflow: hidden;
    }
    
    canvas {
        max-width: 100%;
    }
    
    .global-filter-btn.active {
        background-color: #5a6268;
        color: white;
    }
</style>

